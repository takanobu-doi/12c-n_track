# 12c-n_track
このコードは12C(n,n')X 反応をMAIKo TPC で測定した際の出力データをシミュレーションするコードです．
できるだけ汎用性を高める努力をしているので，他の反応に対しても応用できます．
作成者は京都大学原子核・ハドロン物理学研究室2020年卒の土井隆暢です．

## 依存関係
```
main ┬ show_progress(): シミュレーションの進行状況を表示する関数
     └ mktrack: シミュレーションのメインのクラス
         ├TrackSrim: garfield++ で低エネルギー荷電粒子を扱うクラス
         └gen_eve: 飛跡を生成したいイベントを発生させるクラス
```

## シミュレーションコードの走らせ方

### コンパイル
root, magboltz が既にインストールされていることが前提となる．
maboltzのインストールディレクトリは環境変数でGARFIELD_HOME に代入しておくこと．
正しくインストールされている場合は "$ make"でコンパイルできる．

### シミュレーションの準備
- ガスファイル:
検出ガスのファイルを準備しておく．
maboltzを用いてシミュレーションを行いたいガスで印加するであろう電場をカバーできる領域で計算をしておく．
命名規則は後述．
- SRIMファイル:
SRIM を用いて各荷電粒子のエネルギー損失などを各検出ガスについて計算しておく．
荷電粒子が持つであろうエネルギーをカバーすること．
命名規則は後述．
- 飛程ファイル:
SRIM で計算した結果からエネルギーと飛程の列のみを抽出したもの．
命名規則は後述．

## main 関数
このコードではシミュレーションの状況を出力するために，
メインの作業を別スレッドで処理をして，本体ではshow_progress 関数を走らせている．

### 大まかな流れ
1. main の中でmktrack クラスを生成する．
   - 引数:
     - 生成する散乱イベントのID
     - 検出ガスの圧力
     - 検出ガスの種類
2. mktrack クラスのGenerate 関数を呼ぶ．
   - この関数を呼び出すことで，イベントを発生させ飛跡を生成する．
   - この関数の引数にはstatus とEx の2つが必要であるが，
   どちらもシミュレーションの状況を知るための変数なので必要ない場合はダミー変数を入れれば良い．
   - 返り値はシミュレーションが正しく終了したかどうか．正常終了した場合は1, 異常終了した場合は0 を返す．
   1 が返って来るまで繰り返すべし．
3. mktrack クラスのGetTOT(ac, clk, strp) 関数を呼び出すことで，飛跡画像を取得する．
   - この関数では引数に対応するピクセルの値を返すので，画像全体を取得したい場合はループを回すこと．

### 出力されるファイル
+ *_tot.dat          : 白黒の飛跡画像 (1行につき2 x 1024 x 256) スペースで0と1が区切られている
+ *_flush.dat	     : 波形信号そのままの飛跡画像 (1行についき2 x 1024 x 256) スペースでdouble が区切られている．
+ *_teachervalue.dat : 散乱後の各荷電粒子のrange, phi theta sca_a_x sca_a_y sca_c_x sca_c_y end_a_x end_a_y end_c_x end_c_y
+ *_idealvalue.dat   : 散乱後の各荷電粒子のE M phi theta
+ *_param.dat        : シミュレーションのコマンド引数など

## mktrack クラス
シミュレーションの本体はこのクラスである．
シミュレーションを走らせたり，状況を取得したり，結果を取得したりはこのクラスを通して行う．

### 大まかな流れ
1. コンストラクタ内で初期化とパラメータの設定を行う．
   - 初期化はInitialize 関数で行う．
   - パラメータの設定はSetParameters 関数で行う．
   もし，他の検出器の構成でシミュレートしたい場合はSetParameters 関数の中の値を変更する．
2. Generate 関数で，1 イベントだけシミュレートを開始する．
3. gen_eve クラスのGenerate 関数を呼び出して反応による荷電粒子を生成する．
4. 反応が起きた点を決定する．（デフォルトではある大きさを持つビーム軸上で一様に生成される）
5. gen_eve クラスのGetParticleVector 関数を用いて荷電粒子の4元運動量を取得する．（返り値はTLorentzVector）
6. GenTrack 関数を用いて各荷電粒子の飛跡をTrackSrim で飛跡を生成する．
7. 生成した飛跡を画像に追加する．
8. 生成された飛跡画像のトリガータイミングが統一されるように，clock 方向に微調整する．

### 設定するべきパラメータ
+ 全体に関わるパラメータ
  + beam_name		 : 入射粒子の名前 (string)
  + beam_energy		 : 入射粒子のエネルギー
  + target_name		 : 標的の名前，反応のパターンだけ並べる (vector<string>)
  + particle_name	 : 散乱後に生成される粒子の名前 (vector<vector<vector<string>>>)
  + particle_ex		 : 散乱後の粒子の励起エネルギー (vector<vector<vector<double>>>)
  + particle_flag	 : 散乱後の粒子が有感領域中で停止することを条件にするかどうか (vector<vector<bool>>)
  + dirname		 : Magboltzで生成したガスファイルやSrimファイルが置いてあるディレクトリ
  + BEAM_RADIUS		 : 入射ビームの半径
  + BEAM_X_CENTER	 : 入射ビームのX軸方向の中心位置
  + BEAM_Y_CENTER	 : 入射ビームのY軸方向の中心位置
  + VTX_Z_START		 : 反応点のZ軸方向の最小値
  + VTX_Z_STOP		 : 反応点のZ軸方向の最大値
  + center[3]		 : 有感領域の中心 (X, Y, Z)
  + half[3]		 : ガスチェンバーの大きさの半分 (X, Y, Z)
  + y_plate		 : plate のY座標
  + y_grid		 : grid のY座標
  + area[3][2]		 : 有感領域 (X, Y, Zの最小値と最大値)
  + beam_area[3][2]	 : ビームの有感領域 (X, Y, Z の最小値とX, Y の最大値)
  + Fano_Factor		 : ファノ因子
  + Cluster_Size	 : SrimTrack のクラスターサイズ
  + ie_step		 : 電子をどのくらいの細かさで追跡するか
  + threshold[2]	 : anodeとcathodeに誘起された信号を飛跡画像に変換するときの閾値
  + buff		 : トリガーがかかってから信号を読み出すまでのバッファ
+ 検出ガスごとに変化するパラメータ（switch(Gas)の中に入れること）
  + srim_name            : 検出ガスの名前
  + W_Val		 : W値
  + Mass_Gas		 : 検出ガスの質量数
  + Charge_Gas		 : 検出ガスの電荷
  + density		 : 検出ガスの密度
  + gain		 : 検出ガスの電子増幅率（実測値を設定することを推奨）
  + v_plate		 : plate に印加する電圧
  + v_grid               : grid に印加する電圧

### 各種ファイルの命名規則
検出ガス名は任意の形式でOK．（統一されていれば）
荷電粒子名は"p", "n", "d", "t", "4He", "12C"のようにする．（電荷1以上のものは質量数と元素名）
圧力はhPa 単位で行うこと．
+ ガスファイル: 検出ガス名+圧力+".gas"
+ Srimファイル: 荷電粒子名+"_"+検出ガス名+圧力+".srim
+ waveファイル: wave_temp.dat
+ 飛程ファイル: 荷電粒子名+"_"+検出ガス名+圧力"+_ene_to_range.dat"

## gen_eve クラス
シミュレーションした原子核反応を生成するクラス．
反応を生成するルーチンを変更する場合はこのクラスのGenerate 関数を変更する．
（反応の角度分布を考慮する等）

### 大まかな流れ
1. mktrack クラスで初期化する時にシミュレーションをする原子核反応を受け取る．
2. TGenPhaseSpace クラスを用いて原子核の散乱，崩壊イベントを生成する．
3. 結果をTLorentzVector のvector に詰めていく．